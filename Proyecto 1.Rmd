---
title: "Accidentes de transito en CR entre 2016-2022"
output: html_notebook
---

```{r, echo = FALSE}
data <- read.csv("accidentes_transito_con_victimas_2016_2022.csv", sep = ";")
```

```{r, echo = FALSE, warning = FALSE}
library(dplyr)
library(ggplot2)
library(plotly)
library(colorspace)
library(treemapify)
```

```{r, echo=FALSE, message = FALSE}
#obtenemos los meses, dias y la ruta donde
#mas accidentes hay
meses_dias_RU_mas_accidentes <- data %>%
  filter(grepl("^[A-L]\\..*\\s(Enero|Febrero|Marzo|Abril|Mayo|Junio|Julio|Agosto|Setiembre|Octubre|Noviembre|Diciembre)$", Mes)) %>%
  filter(grepl("^[1-7]\\.(Domingo|Lunes|Martes|Mi√©rcoles|Jueves|Viernes|S√°bado)$", D√≠a)) %>%
  group_by(Mes,D√≠a,Ruta) %>%
  summarise(MDtotal_accidentes = n()) %>%
  arrange(desc(MDtotal_accidentes))

registros_mas_frecuentes <- meses_dias_RU_mas_accidentes %>%
  group_by(Mes) %>%
  slice(1)
  
numero_mes <- seq(1, 12, length.out = nrow(registros_mas_frecuentes))
numero_mes <- as.integer(numero_mes)
registros_mas_frecuentes <- cbind(registros_mas_frecuentes, NumeroMes = numero_mes)

# Crear una columna para el n√∫mero de d√≠a seg√∫n el d√≠a de la semana en registros_mas_frecuentes
registros_mas_frecuentes$ColorDia <-ifelse(registros_mas_frecuentes$D√≠a == "1.Domingo", "blue",
                                            ifelse(registros_mas_frecuentes$D√≠a == "2.Lunes", "red",
                                            ifelse(registros_mas_frecuentes$D√≠a == "3.Martes", "yellow",
                                            ifelse(registros_mas_frecuentes$D√≠a == "4.Mi√©rcoles", "cyan",
                                            ifelse(registros_mas_frecuentes$D√≠a == "5.Jueves", "darkgreen",
                                            ifelse(registros_mas_frecuentes$D√≠a == "6.Viernes", "brown",
                                            ifelse(registros_mas_frecuentes$D√≠a == "7.S√°bado", "black", NA)))))))

registros_mas_frecuentes$idRuta <-ifelse(registros_mas_frecuentes$Ruta == "Cantonal", 1)
                                          
registros_mas_frecuentes$Mes <- gsub("[A-L]\\.", "", registros_mas_frecuentes$Mes)

registros_mas_frecuentes$D√≠a <- gsub("[1-7]\\.", "", registros_mas_frecuentes$D√≠a)

```

```{r, echo = FALSE}
grafico_chernoff <- ggplot(registros_mas_frecuentes, aes(x = NumeroMes, y = idRuta,label1 = Mes,label2 = Ruta,label3 = D√≠a)) +
  geom_point(size = 9,colour = registros_mas_frecuentes$ColorDia) +
  labs(x = "Mes",y = "Ruta") +
  geom_text(aes(label = "üëÅÔ∏è üëÅÔ∏è"),vjust = -5, size = 3)+  
  geom_text(aes(label = "üëÑ"), vjust = 5, size = 2) +
  theme_bw()

# Convertimos el gr√°fico ggplot2 en uno interactivo con plotly
grafico_interactivo <- ggplotly(grafico_chernoff,tooltip = c("label1", "label2", "label3"))

# Mostramos el gr√°fico interactivo
grafico_interactivo

# 12 caras por los meses, color cara dias ... y tamanho cara ruta
```
En esta gr√°fica de accidentes entre el 2016-2022 de caras de Chernoff podemos observar en un inicio que hay 12 caras, una por cada mes del a√±o. Segundo hay variedad de colores, los cuales representan el d√≠a con m√°s accidentes de ese mes. Y por √∫ltimo todas las caras tiene el mismo tama√±o, ya que el tama√±o lo determina la ruta con m√°s accidentes. Teniendo esto en cuenta, porque tiene el mismo tama√±o todas las caras? Pues los datos de an√°lisis indican que a trav√©s del intervalo de a√±os entre el 2016-2022 las rutas con m√°s accidentes han sido las cantonales. Es muy interesante que en ese intervalo de a√±os el d√≠a que suele tener m√°s accidentes es el viernes, adem√°s el Lunes y S√°bado sueles tener la misma cantidad de accidentes.
```{r,echo=FALSE}
ruralUrbano_mas_accidentes<-data %>%
  group_by(Rural.o.urbano)%>%
  summarise(RUtotal_accidentes = n()) %>%
  arrange(desc(RUtotal_accidentes))
# desde 2016 hastas 2022
```

```{r,echo=FALSE}
labels = ruralUrbano_mas_accidentes$Rural.o.urbano
values = ruralUrbano_mas_accidentes$RUtotal_accidentes

fig1 <- plot_ly(type='pie', labels=labels, values=values, 
               textinfo='label+percent',
               insidetextorientation='radial')
fig1 <- fig1 %>% layout(title = 'Accidentes por ruta entre 2016-2022')
fig1
```
En este gr√°fico de paste se muestra el porcentaje de los accidentes entre el 2016-2022 por tipo de ruta. Se puede apreciar que el mayor porcentaje de accidentes en el intervalo de a√±os se ha dado en rutas urbana, eso quiz√° tenga que ver en parte porque hay menos tr√°nsito en rutas rurales. Con lo anterior en cuenta, tambi√©n puede ser que porque hay menos cantidad de tr√°nsito hayan menos factores psicoemocionales que afecten al momento de conducir.
```{r,echo=FALSE}
#y =mideplan x= canton
#tener canton con mas y menos accidentes
region_canton_mas_accidentes<-data%>%
  group_by(Regi√≥n.Mideplan, Cant√≥n)%>%
  summarise(RCtotal_accidentes = n(),.groups = "drop")

region_canton_mas_accidentes<-region_canton_mas_accidentes%>%
  group_by(Regi√≥n.Mideplan, Cant√≥n)%>%
  summarise(max_valor = max(RCtotal_accidentes),.groups = "drop")%>%
  arrange(max_valor)

# N√∫mero de colores deseado
n_colores <- 176

# Generar la paleta de colores

paleta_colores <-rainbow_hcl(n_colores) # Ejemplo de colores base
```

```{r,echo=FALSE}

fig <- plot_ly(region_canton_mas_accidentes, x = ~Regi√≥n.Mideplan, y = ~max_valor, marker = list(color=paleta_colores) , type = 'bar',hovertemplate = ~paste("Regi√≥n: ", Regi√≥n.Mideplan, "<br>Cant√≥n: ", Cant√≥n, "<br>Valor: ", max_valor,
      "<extra></extra>"))

fig <- fig %>% layout(yaxis = list(title = ''),xaxis=list(title = ''), barmode = 'stack')

fig
```
Entre 2016-2022, la gr√°fica apilada de barras muestra que las barras est√°n agrupadas por regi√≥n y apiladas por cantones con mayor n√∫mero de accidentes. El color indica cu√°ntos accidentes hubieron en cada cant√≥n. En la zona de Costa Rica, donde m√°s accidentes ocurrieron, la regi√≥n central y el cant√≥n de San Jos√© tienen el mayor n√∫mero de accidentes. Adem√°s, los cantones que comparten m√°s accidentes son los m√°s desarrollados urbanamente, mientras que los cantones con menos accidentes son los m√°s pobres o menos desarrollados. Esto se podr√≠a deber a que hay menos veh√≠culos en carretera, por la falta de poder adquisitivo.
```{r, echo = FALSE}
anioCTG<-data %>%
  group_by(A√±o,Tipo.de.circulaci√≥n,Estado.del.tiempo,Clase.de.accidente) %>%
  summarise(NumeroAccidentes=n(),.groups="drop")

anioCTG<-anioCTG%>%
  group_by(A√±o,Tipo.de.circulaci√≥n,Estado.del.tiempo,Clase.de.accidente)%>%
  summarise(Accidentes = min(NumeroAccidentes),.groups = "drop")%>%
  arrange(Accidentes)
anioCTG<-anioCTG%>%
  rename(Circulacion = Tipo.de.circulaci√≥n)%>%
  rename(Clima = Estado.del.tiempo)%>%
  rename(Gravedad = Clase.de.accidente)

anioCTG$A√±o<-substr(anioCTG$A√±o, start = 3, stop = nchar(anioCTG$A√±o))
#elimino el 20 del a√±o para que sea mejor la respresentaci√≥n textual
#o sea en vez de 2016 sale 16
```

```{r,echo=FALSE}
faceInteractivo <- ggplot(anioCTG, aes(x=Circulacion, y=Accidentes, color=Clima, group=Gravedad)) +
    geom_point()+
    labs(x="Tipo de circulaci√≥n",y="Cantidad accidentes",colour=" Estado del clima")+
  scale_y_continuous(limits = c(0, 2600), breaks = c(0, 2600))+
  theme(axis.text.x = element_text(angle = -45, hjust = 0),axis.text.y = element_text(angle=12))+
    facet_grid(A√±o ~ ., scale = "free_x",space = "free")
    

ggplotly(faceInteractivo)
```
Esta gr√°fica muestra el m√≠nimo de accidentes por a√±o, tipo de circulaci√≥n, estado del clima y son agrupados por la gravedad del accidente. La mayor√≠a de los accidentes curiosamente se dan con buen tiempo, contrariamente a lo que se esperar√≠a que sea m√°s bien en un mal clima como la lluvia. Esto quiere decir que si hay un buen clima los conductores se relajan y no andan lo suficientemente atentos al ambiente. Esto tiene un efecto inmediato con el tipo de circulaci√≥n, ya que al no tomar la suficiente precauci√≥n se terminan accidentando, y estos en su mayor√≠a son de extrema gravedad.
```{r, echo = FALSE}
# Calcular la cantidad de accidentes por a√±o
frecuencia_a√±o <- table(data$A√±o)

# Crear un frame de datos con la frecienca y el a√±o
datos_frecuencia_a√±o <- data.frame(
  A√±o = names(frecuencia_a√±o),
  Accidentes = as.numeric(frecuencia_a√±o)
)

# Crear el grafico con un punto por cada a√±o
puntos_a√±o <- ggplot(datos_frecuencia_a√±o, aes(x = A√±o, y = Accidentes, color = A√±o)) +
  geom_point(size = 5) +
  scale_x_discrete(breaks = NULL) +
  labs(y = "# de accidentes", 
       title = "Cantidad de accidentes por a√±o") +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank())

puntos_a√±os_interactiva <- ggplotly(puntos_a√±o)
```

```{r, echo = FALSE}
barras_hora <- ggplot(data, aes(x = Hora.recodificada, fill = Hora.recodificada)) +
  geom_bar() +
  labs(title = "Accidentes por a√±o y por Hora recodificada",
       x = "Hora Recodificada", y = "# de accidentes", fill = "A√±o / Rango horario") +
  theme(axis.text.x = element_blank())

barras_hora_interactiva <- ggplotly(barras_hora)
```

```{r, echo = FALSE}
barras_tipo_clase <- ggplot(data, aes(x = Tipo.de.accidente, fill = Clase.de.accidente)) +
  geom_bar() +
  labs(title = "Tipos de heridos por tipo de accidente entre 2016-2022",
       x = "Tipo de accidente", y = "# de accidentes", fill = "Tipo de heridos") +
  theme(axis.text.x = element_text(angle = 315, hjust = 0))

ggplotly(barras_tipo_clase)
```

```{r,echo=FALSE}
datos_multidimensionales<-data%>%
  filter(grepl("^[1-7]\\.(Domingo|Lunes|Martes|Mi√©rcoles|Jueves|Viernes|S√°bado)$", D√≠a)) %>%
  group_by(Hora.recodificada,D√≠a,Estado.del.tiempo,Tipo.de.calzada,Tipo.de.circulaci√≥n)%>%
  summarise(accidentes=n(),.groups = "drop")

datos_multidimensionales$D√≠a <- gsub("[1-7]\\.", "", datos_multidimensionales$D√≠a)
  
```


```{r,echo=FALSE}
axis = list(showline=FALSE,
            zeroline=FALSE,
            gridcolor='#ffff',
            ticklen=1)

matrizD <- datos_multidimensionales %>%
  plot_ly() 
matrizD <- matrizD %>%
  add_trace(
    type = 'splom',
    dimensions = list(
      list(label='D√≠a',values=~D√≠a),
      list(label='Tr√°nsito',values=~Tipo.de.circulaci√≥n),
      list(label='Hora',values=~Hora.recodificada),
      list(label='V√≠a',values=~Tipo.de.calzada),
      list(label='Clima',values=~Estado.del.tiempo)
    )
  )
matrizD <- matrizD %>%
  layout(
    title= 'Accidentes del 2016-2022 evaluando distintos factores',
    hovermode='closest',
    dragmode= 'select',
    plot_bgcolor='rgba(240,240,240, 0.95)',
    xaxis=list(domain=NULL, showline=F, zeroline=F, gridcolor='#ffff', ticklen=4),
    yaxis=list(domain=NULL, showline=F, zeroline=F, gridcolor='#ffff', ticklen=4),
    xaxis2=axis,
    xaxis3=axis,
    xaxis4=axis,
    yaxis2=axis,
    yaxis3=axis,
    yaxis4=axis
  )

matrizD <- matrizD %>%
  layout(
  xaxis = list(tickvals = NULL, ticktext = NULL),
  xaxis2 = list(tickvals = NULL, ticktext = NULL),
  xaxis3 = list(tickvals = NULL, ticktext = NULL),
  xaxis4 = list(tickvals = NULL, ticktext = NULL),
  xaxis5 = list(tickvals = NULL, ticktext = NULL),
  yaxis = list(tickvals = NULL, ticktext = NULL),
  yaxis2 = list(tickvals = NULL, ticktext = NULL),
  yaxis3 = list(tickvals = NULL, ticktext = NULL),
  yaxis4 = list(tickvals = NULL, ticktext = NULL),
  yaxis5 = list(tickvals = NULL, ticktext = NULL)
)
matrizD


```

```{r, echo = FALSE}
grafica_de_graficas <- subplot(puntos_a√±os_interactiva, barras_hora_interactiva, nrows = 2)

grafica_de_graficas
```